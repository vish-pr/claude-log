<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Code Log Viewer</title>
<style>
:root {
  --bg: #0d1117; --bg-1: #161b22; --bg-2: #21262d; --border: #30363d;
  --text: #c9d1d9; --text-bright: #e6edf3; --text-muted: #6e7681;
  --accent: #90b8d0; --accent-fill: #2a4a5c; --green: #7ee787; --purple: #d2a8ff; --yellow: #d29922; --red: #f85149;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', Consolas, monospace; background: var(--bg); color: var(--text); font-size: 13px; line-height: 1.5; }

/* Drop zone */
#drop-zone { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 32px; }
#drop-zone.has-content { display: none; }
.drop-area { border: 2px dashed var(--border); border-radius: 8px; padding: 32px; text-align: center; max-width: 600px; width: 100%; transition: border-color 0.2s; }
.drop-area:hover, .drop-area.drag-over { border-color: var(--accent); }
.drop-area h1 { font-size: 1.3rem; color: var(--text-bright); margin-bottom: 8px; font-weight: 600; }
.drop-area p { color: var(--text-muted); margin-bottom: 24px; font-size: 0.85rem; }
input[type="file"] { display: none; }
.pick-btn { background: var(--accent-fill); color: var(--text-bright); border: none; padding: 8px 24px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.85rem; font-weight: 500; transition: background 0.15s; }
.pick-btn:hover { background: #345e73; }
.btn-row { display: flex; gap: 12px; justify-content: center; margin-bottom: 24px; }

/* Recent sessions list */
.recent-list { text-align: left; width: 100%; }
.recent-list h2 { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; font-weight: 500; }
.recent-item { display: flex; align-items: center; gap: 8px; padding: 8px; border: none; border-radius: 4px; margin-bottom: 4px; cursor: pointer; transition: background 0.15s; }
.recent-item:hover { background: var(--bg-1); }
.recent-slug { color: var(--text-bright); font-size: 0.8rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; }
.recent-project { color: var(--text-muted); font-size: 0.7rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; flex-shrink: 0; }
.recent-meta, .msg-time { color: var(--text-muted); font-size: 0.7rem; flex-shrink: 0; white-space: nowrap; }
.recent-loading { color: var(--text-muted); font-size: 0.8rem; padding: 16px 0; }
.refresh-btn { background: none; border: 1px solid var(--border); color: var(--accent); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 0.7rem; margin-left: 8px; }
.refresh-btn:hover { background: var(--bg-1); border-color: var(--accent); }

/* Viewer */
#viewer { display: none; max-width: 1100px; margin: 0 auto; padding: 16px; }
#viewer.active { display: block; }

/* Stats bar — flat */
.stats-bar { padding: 12px 16px; margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 8px 24px; align-items: center; border-bottom: 1px solid var(--border); }
.stat { display: flex; align-items: center; gap: 4px; }
.stat-label { color: var(--text-muted); font-size: 0.75rem; }
.stat-value { color: var(--text-bright); font-weight: 600; font-size: 0.85rem; }

/* Toolbar */
.toolbar { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; }
.toolbar button { background: var(--bg-2); border: none; color: var(--text); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 0.75rem; }
.toolbar button:hover { background: var(--border); }
.toolbar button.active { background: var(--accent-fill); color: var(--text-bright); }
.toolbar .spacer { flex: 1; }
.toolbar .file-name { color: var(--text-muted); font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 400px; }
.reload-btn { background: var(--bg-2) !important; color: var(--text) !important; }

/* Message cards */
.message { border: none; border-left: 3px solid var(--bg-2); margin-bottom: 4px; overflow: hidden; transition: border-color 0.15s; }
.message.type-user { border-left-color: var(--accent); }
.message.type-assistant { border-left-color: var(--green); }
.message.type-system { border-left-color: var(--yellow); }
.message.type-queue-operation { border-left-color: var(--text-muted); }
.message.type-summary { border-left-color: var(--purple); }
.msg-header { display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; user-select: none; background: var(--bg-1); }
.msg-header:hover { background: var(--bg-2); }
.msg-chevron { color: var(--text-muted); font-size: 0.7rem; transition: transform 0.15s; width: 1em; flex-shrink: 0; }
.message.open .msg-chevron { transform: rotate(90deg); }

/* Badges — unified bg, role-colored text */
.badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; flex-shrink: 0; background: var(--bg-2); }
.badge-user { color: var(--accent); }
.badge-assistant { color: var(--green); }
.badge-system { color: var(--yellow); }
.badge-queue-operation { color: var(--text-muted); }
.badge-summary { color: var(--purple); }

.msg-preview { color: var(--text-muted); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.8rem; min-width: 0; }
.copy-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; transition: color 0.15s, background 0.15s; }
.copy-btn:hover { color: var(--text); background: var(--border); }
.copy-btn.copied { color: var(--green); }
.copy-btn svg { width: 14px; height: 14px; }

/* Token pills — text only, no backgrounds */
.msg-tokens { font-size: 0.7rem; flex-shrink: 0; display: flex; gap: 4px; }
.msg-tokens span { padding: 0; }
.tok-in { color: var(--accent); }
.tok-out { color: var(--green); }
.tok-cache { color: var(--purple); }

/* Message body */
.msg-body { display: none; padding: 12px; background: var(--bg); border-top: 1px solid var(--bg-2); }
.message.open .msg-body { display: block; }
.content-block { margin-bottom: 12px; }
.content-block:last-child { margin-bottom: 0; }
.text-block { white-space: pre-wrap; word-break: break-word; color: var(--text); }
.text-block code { background: var(--bg-1); padding: 4px; border-radius: 4px; font-size: 0.9em; }

/* Tool blocks — unified */
.tool-block, .tool-result-block { border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
.tool-block summary, .tool-result-block summary { padding: 4px 8px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 4px; list-style: none; background: var(--bg-1); }
.tool-block summary::-webkit-details-marker, .tool-result-block summary::-webkit-details-marker { display: none; }
.tool-block summary::before, .tool-result-block summary::before { content: '\25b6'; font-size: 0.6rem; color: var(--text-muted); transition: transform 0.15s; }
.tool-block[open] summary::before, .tool-result-block[open] summary::before { transform: rotate(90deg); }
.tool-name { color: var(--purple); font-weight: 600; }
.tool-input-preview { color: var(--text-muted); margin-left: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.tool-body, .tool-result-body { padding: 8px; background: var(--bg); max-height: 400px; overflow: auto; }
.tool-body pre, .tool-result-body pre { white-space: pre-wrap; word-break: break-word; font-size: 0.8rem; color: var(--text-muted); }
.result-label { color: var(--accent); font-weight: 600; }
.result-error .result-label { color: var(--red); }

.meta-row { display: flex; gap: 16px; flex-wrap: wrap; font-size: 0.7rem; color: var(--text-muted); margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--bg-2); }
.meta-row span { display: flex; align-items: center; gap: 4px; }
.message.filter-hidden { display: none; }

/* Scrollbar */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* Accessibility */
*:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
}

/* Responsive */
@media (max-width: 640px) {
  .stat-label { display: none; }
  .msg-tokens { display: none; }
  .recent-project { display: none; }
  .toolbar { flex-wrap: wrap; }
  .toolbar .file-name { flex-basis: 100%; }
  .toolbar button { padding: 8px 12px; }
  .msg-header { padding: 12px; }
  .recent-item { padding: 12px; }
}
</style>
</head>
<body>
<div id="drop-zone">
  <div class="drop-area" id="drop-area">
    <h1>Claude Code Log Viewer</h1>
    <p>Drop a .jsonl file or the ~/.claude/projects/ folder</p>
    <div class="btn-row">
      <button class="pick-btn" onclick="document.getElementById('file-input').click()">Choose .jsonl file</button>
      <button class="pick-btn" id="pick-dir-btn">Choose projects folder</button>
    </div>
    <input type="file" id="file-input" accept=".jsonl">
    <div id="recent-container"></div>
  </div>
</div>
<div id="viewer" aria-label="Log viewer">
  <div class="stats-bar" id="stats-bar"></div>
  <div class="toolbar" id="toolbar"></div>
  <div id="messages"></div>
</div>

<script>
const COPY_ICON = '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25z"/></svg>';
const CHECK_ICON = '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"/></svg>';
const $ = s => document.querySelector(s), $$ = s => document.querySelectorAll(s);
const [fileInput, dropArea, dropZone, viewer] = ['#file-input', '#drop-area', '#drop-zone', '#viewer'].map($);
let currentFileName = '', lastDirHandle = null, currentFileHandle = null;

fileInput.addEventListener('change', e => { if (e.target.files[0]) loadFile(e.target.files[0]); });
dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('drag-over'); });
dropArea.addEventListener('dragleave', () => dropArea.classList.remove('drag-over'));
dropArea.addEventListener('drop', e => { e.preventDefault(); dropArea.classList.remove('drag-over'); if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]); });
$('#pick-dir-btn').addEventListener('click', pickDirectory);

async function pickDirectory() {
  try { const h = await window.showDirectoryPicker({ startIn: lastDirHandle || 'documents' }); await storeDirHandle(h); scanDirHandle(h); } catch {}
}

// IndexedDB for directory handle persistence
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('log-viewer', 1);
    req.onupgradeneeded = () => req.result.createObjectStore('kv');
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function storeDirHandle(handle) {
  try { const db = await openDB(); const tx = db.transaction('kv', 'readwrite'); tx.objectStore('kv').put(handle, 'projectsDir'); await new Promise(r => { tx.oncomplete = r; }); } catch {}
}

async function loadStoredDirHandle() {
  try { const db = await openDB(); const tx = db.transaction('kv', 'readonly'); const req = tx.objectStore('kv').get('projectsDir'); return new Promise(r => { req.onsuccess = () => r(req.result || null); req.onerror = () => r(null); }); } catch { return null; }
}

(async function autoLoad() {
  const handle = await loadStoredDirHandle();
  if (!handle) return;
  if (await handle.queryPermission({ mode: 'read' }) === 'granted') return scanDirHandle(handle);
  lastDirHandle = handle;
  $('#pick-dir-btn').textContent = 'Open saved projects folder';
  $('#pick-dir-btn').onclick = async () => {
    if (await handle.requestPermission({ mode: 'read' }) === 'granted') scanDirHandle(handle); else pickDirectory();
  };
})();

async function scanDirHandle(dirHandle) {
  lastDirHandle = dirHandle;
  $('#recent-container').innerHTML = '<div class="recent-loading">Scanning for .jsonl files...</div>';
  dropArea.classList.add('has-list');
  const files = [];
  await walkHandle(dirHandle, '', files);
  showRecentFiles(files);
}

async function walkHandle(dirHandle, path, files) {
  for await (const entry of dirHandle.values()) {
    if (entry.kind === 'file' && entry.name.endsWith('.jsonl')) { const f = await entry.getFile(); f._dirPath = path; f._fileHandle = entry; files.push(f); }
    else if (entry.kind === 'directory') await walkHandle(entry, entry.name, files);
  }
}

function parseQuickStats(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      const lines = e.target.result.split('\n').filter(l => l.trim());
      let firstMsg = '', model = '', firstTs = null, lastTs = null;
      const reqIds = new Set();
      for (const line of lines) {
        try {
          const obj = JSON.parse(line);
          const ts = obj.timestamp ? new Date(obj.timestamp) : null;
          if (ts) { if (!firstTs || ts < firstTs) firstTs = ts; if (!lastTs || ts > lastTs) lastTs = ts; }
          if (!model && obj.message?.model) model = obj.message.model;
          if (obj.type === 'assistant' && obj.requestId) reqIds.add(obj.requestId);
          if (!firstMsg && obj.type === 'user') {
            const c = obj.message?.content;
            if (typeof c === 'string') firstMsg = c.split('\n')[0].slice(0, 150);
            else if (Array.isArray(c)) { for (const b of c) { if (b.type === 'text' && b.text?.trim()) { firstMsg = b.text.trim().split('\n')[0].slice(0, 150); break; } } }
          }
        } catch {}
      }
      resolve({ firstMsg, model, firstTs, lastTs, turns: reqIds.size, msgCount: lines.length });
    };
    reader.readAsText(file);
  });
}

async function showRecentFiles(files) {
  files.sort((a, b) => b.lastModified - a.lastModified);
  const top = files.slice(0, 10), container = $('#recent-container');
  if (!top.length) { container.innerHTML = '<div class="recent-loading">No .jsonl files found.</div>'; return; }
  container.innerHTML = '<div class="recent-loading">Parsing stats...</div>';
  const infos = [];
  for (const f of top) infos.push({ file: f, stats: await parseQuickStats(f), project: extractProject(f) });
  container.innerHTML = `<div class="recent-list"><h2>Recent sessions (${files.length} total) <button class="refresh-btn" id="refresh-btn">Refresh</button></h2></div>`;
  const list = container.querySelector('.recent-list');
  $('#refresh-btn').addEventListener('click', () => lastDirHandle && scanDirHandle(lastDirHandle));
  for (const { file: f, stats, project } of infos) {
    const el = document.createElement('div');
    el.className = 'recent-item';
    const label = stats.firstMsg || f.name.replace('.jsonl', '').slice(0, 20);
    const sizeStr = f.size >= 1048576 ? (f.size / 1048576).toFixed(1) + ' MB' : f.size >= 1024 ? (f.size / 1024).toFixed(0) + ' KB' : f.size + ' B';
    const dateStr = relativeTime(stats.lastTs || new Date(f.lastModified));
    const modelStr = stats.model ? stats.model.replace('claude-', '').split('-202')[0] : '';
    const turnStr = stats.turns ? stats.turns + ' turns' : '';
    el.innerHTML = `<span class="recent-slug" title="${esc(label)}">${esc(label)}</span><span class="recent-project" title="${esc(project)}">${esc(project)}</span><span class="recent-meta">${[modelStr, turnStr, sizeStr, dateStr].filter(Boolean).join(' · ')}</span>`;
    el.addEventListener('click', async () => {
      if (f._fileHandle) { try { const fresh = await f._fileHandle.getFile(); fresh._fileHandle = f._fileHandle; loadFile(fresh); } catch (err) { console.error('Failed to re-read file:', err); loadFile(f); } }
      else loadFile(f);
    });
    list.appendChild(el);
  }
}

function extractProject(file) { const d = file._dirPath || ''; return d ? d.replace(/^-/, '').replaceAll('-', '/') : ''; }

function relativeTime(date) {
  const mins = Math.floor((Date.now() - date.getTime()) / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  return days < 7 ? days + 'd ago' : date.toLocaleDateString();
}

function loadFile(file) {
  currentFileName = file.name;
  currentFileHandle = file._fileHandle || null;
  dropZone.classList.add('has-content');
  viewer.classList.add('active');
  $('#stats-bar').innerHTML = '';
  $('#toolbar').innerHTML = `<span class="file-name">${esc(file.name)}</span><span class="spacer"></span>`;
  $('#messages').innerHTML = '<div class="recent-loading">Loading ' + esc(file.name) + '...</div>';
  const reader = new FileReader();
  reader.onerror = () => {
    console.error('FileReader error:', reader.error);
    $('#messages').innerHTML = `<div class="recent-loading" style="color:var(--red)">Failed to read file: ${esc(reader.error?.message || 'unknown error')}</div>`;
  };
  reader.onload = e => {
    try {
      const entries = [];
      for (const line of e.target.result.split('\n')) { if (line.trim()) try { entries.push(JSON.parse(line)); } catch {} }
      render(entries);
    } catch (err) {
      console.error('Render error:', err);
      $('#messages').innerHTML = `<div class="recent-loading" style="color:var(--red)">Error rendering log: ${esc(err.message)}</div>`;
    }
  };
  reader.readAsText(file);
}

async function refreshCurrentFile() {
  if (!currentFileHandle) return;
  try {
    const file = await currentFileHandle.getFile();
    file._fileHandle = currentFileHandle;
    loadFile(file);
  } catch {}
}

function render(entries) {
  dropZone.classList.add('has-content');
  viewer.classList.add('active');
  const stats = { inputTokens: 0, outputTokens: 0, cacheRead: 0, cacheWrite: 0, turns: 0, messages: entries.length, model: '', firstTs: null, lastTs: null };
  const typeSet = new Set(), skipTypes = new Set(['file-history-snapshot', 'progress']);

  for (const e of entries) {
    typeSet.add(e.type);
    const ts = e.timestamp ? new Date(e.timestamp) : null;
    if (ts) { if (!stats.firstTs || ts < stats.firstTs) stats.firstTs = ts; if (!stats.lastTs || ts > stats.lastTs) stats.lastTs = ts; }
    if (e.type === 'assistant') {
      const u = e.message?.usage;
      if (u) { stats.inputTokens += u.input_tokens || 0; stats.outputTokens += u.output_tokens || 0; stats.cacheRead += u.cache_read_input_tokens || 0; stats.cacheWrite += u.cache_creation_input_tokens || 0; }
      if (!stats.model && e.message?.model) stats.model = e.message.model;
      if (e.message?.stop_reason === 'end_turn' || e.message?.stop_reason === 'stop_sequence') stats.turns++;
    }
  }
  if (stats.turns === 0) { const r = new Set(); for (const e of entries) if (e.type === 'assistant' && e.requestId) r.add(e.requestId); stats.turns = r.size; }

  const duration = stats.firstTs && stats.lastTs ? Math.round((stats.lastTs - stats.firstTs) / 1000) : 0;
  const durationStr = duration > 0 ? (duration < 60 ? `${duration}s` : `${Math.floor(duration/60)}m ${duration%60}s`) : '-';
  const fmt = n => n >= 1e6 ? (n/1e6).toFixed(1) + 'M' : n >= 1000 ? (n/1000).toFixed(1) + 'k' : String(n);
  const mkStat = (l, v) => `<div class="stat"><span class="stat-label">${l}</span><span class="stat-value">${v}</span></div>`;

  $('#stats-bar').innerHTML = [mkStat('Model', stats.model || '-'), mkStat('Duration', durationStr), mkStat('Turns', stats.turns), mkStat('Messages', stats.messages), mkStat('Input', fmt(stats.inputTokens)), mkStat('Output', fmt(stats.outputTokens)), mkStat('Cache Read', fmt(stats.cacheRead)), mkStat('Cache Write', fmt(stats.cacheWrite))].join('');

  const filterTypes = ['user', 'assistant', 'system', 'queue-operation', 'summary'].filter(t => typeSet.has(t));
  $('#toolbar').innerHTML = `<span class="file-name" title="${esc(currentFileName)}">${esc(currentFileName)}</span><span class="spacer"></span>${filterTypes.map(t => `<button class="filter-btn active" data-type="${t}">${t}</button>`).join('')}<button id="expand-all-btn">Expand All</button><button id="collapse-all-btn">Collapse All</button>${currentFileHandle ? '<button id="refresh-log-btn">Refresh</button>' : ''}<button class="reload-btn" id="back-btn">Back</button>`;

  $$('.filter-btn').forEach(btn => btn.addEventListener('click', () => { btn.classList.toggle('active'); applyFilters(); }));
  if ($('#refresh-log-btn')) $('#refresh-log-btn').addEventListener('click', refreshCurrentFile);
  $('#back-btn').addEventListener('click', () => { dropZone.classList.remove('has-content'); viewer.classList.remove('active'); $('#messages').innerHTML = ''; if (lastDirHandle) scanDirHandle(lastDirHandle); });
  $('#expand-all-btn').addEventListener('click', () => $$('.message:not(.filter-hidden)').forEach(m => m.classList.add('open')));
  $('#collapse-all-btn').addEventListener('click', () => $$('.message').forEach(m => m.classList.remove('open')));

  // Group consecutive assistant entries with same requestId
  const grouped = [], toolCallNames = {};
  for (let i = 0; i < entries.length;) {
    const e = entries[i];
    if (skipTypes.has(e.type)) { i++; continue; }
    if (e.type === 'assistant' && e.requestId) {
      const reqId = e.requestId, group = { ...e, _mergedContent: [], _usage: null };
      while (i < entries.length && entries[i].type === 'assistant' && entries[i].requestId === reqId) {
        const a = entries[i];
        if (a.message?.content) for (const block of a.message.content) group._mergedContent.push(block);
        if (a.message?.usage) group._usage = a.message.usage;
        if (a.message?.stop_reason) group._stopReason = a.message.stop_reason;
        if (!group.timestamp && a.timestamp) group.timestamp = a.timestamp;
        i++;
      }
      grouped.push(group);
    } else { grouped.push(e); i++; }
  }
  for (const e of grouped) if (e._mergedContent) for (const b of e._mergedContent) if (b.type === 'tool_use') toolCallNames[b.id] = b.name;

  const container = $('#messages');
  container.innerHTML = '';
  for (const e of grouped) {
    const el = document.createElement('div');
    el.className = `message type-${e.type}`;
    el.dataset.type = e.type;
    el.innerHTML = `<div class="msg-header"><span class="msg-chevron">&#9654;</span><span class="badge badge-${e.type}">${badgeLabel(e)}</span><span class="msg-preview">${esc(getPreview(e))}</span>${getTokenHTML(e)}<button class="copy-btn" title="Copy">${COPY_ICON}</button><span class="msg-time">${e.timestamp ? new Date(e.timestamp).toLocaleTimeString() : ''}</span></div><div class="msg-body">${renderBody(e, toolCallNames)}</div>`;
    const copyBtn = el.querySelector('.copy-btn');
    copyBtn.addEventListener('click', ev => { ev.stopPropagation(); copyMessage(copyBtn, e, toolCallNames); });
    el.querySelector('.msg-header').addEventListener('click', () => el.classList.toggle('open'));
    container.appendChild(el);
  }
  applyFilters();
}

function applyFilters() { const a = new Set(); $$('.filter-btn.active').forEach(b => a.add(b.dataset.type)); $$('.message').forEach(m => m.classList.toggle('filter-hidden', !a.has(m.dataset.type))); }
function badgeLabel(e) { return e.type === 'queue-operation' ? 'queue' : e.type === 'system' ? (e.subtype || 'system') : e.type; }
function fmtTok(n) { return n >= 1000 ? (n/1000).toFixed(1) + 'k' : String(n); }

function getPreview(e) {
  if (e.type === 'queue-operation') return `${e.operation || ''} — session ${(e.sessionId || '').slice(0, 8)}`;
  if (e.type === 'summary') return e.summary || '';
  if (e._mergedContent) {
    for (const b of e._mergedContent) { if (b.type === 'text' && b.text?.trim()) return b.text.trim().slice(0, 120); if (b.type === 'tool_use') return `tool: ${b.name}`; }
    return '(empty)';
  }
  if (!e.message) return e.type === 'system' ? (e.subtype ? `${e.subtype}${e.durationMs ? ' — ' + (e.durationMs / 1000).toFixed(1) + 's' : ''}` : '(system)') : '(no content)';
  const c = e.message.content;
  if (typeof c === 'string') return c.slice(0, 120);
  if (Array.isArray(c)) for (const b of c) { if (b.type === 'text' && b.text?.trim()) return b.text.trim().slice(0, 120); if (b.type === 'tool_result') return `result: ${(typeof b.content === 'string' ? b.content : (b.content?.[0]?.text || '')).slice(0, 100)}`; }
  return '(no content)';
}

function getTokenHTML(e) {
  const u = e._usage || e.message?.usage;
  if (!u) return '';
  const parts = [];
  const inp = (u.input_tokens || 0) + (u.cache_read_input_tokens || 0) + (u.cache_creation_input_tokens || 0);
  if (inp) parts.push(`<span class="tok-in">in:${fmtTok(inp)}</span>`);
  if (u.output_tokens) parts.push(`<span class="tok-out">out:${fmtTok(u.output_tokens)}</span>`);
  if (u.cache_read_input_tokens) parts.push(`<span class="tok-cache">cached:${fmtTok(u.cache_read_input_tokens)}</span>`);
  return parts.length ? `<span class="msg-tokens">${parts.join('')}</span>` : '';
}

function renderBody(e, toolCallNames) {
  if (e.type === 'queue-operation') return `<pre class="text-block">${esc(JSON.stringify(e, null, 2))}</pre>`;
  if (e.type === 'summary') return `<div class="text-block">${esc(e.summary || '')}</div>`;
  if (e.type === 'system') { const p = []; if (e.subtype) p.push(`Subtype: ${e.subtype}`); if (e.durationMs) p.push(`Duration: ${(e.durationMs / 1000).toFixed(1)}s`); p.push(JSON.stringify(e, null, 2)); return `<pre class="text-block">${esc(p.join('\n'))}</pre>`; }
  if (e._mergedContent) return renderContentBlocks(e._mergedContent, toolCallNames) + renderMeta(e);
  if (!e.message) return `<pre class="text-block">${esc(JSON.stringify(e, null, 2))}</pre>`;
  const c = e.message.content;
  if (typeof c === 'string') return `<div class="text-block">${esc(c)}</div>` + renderMeta(e);
  if (Array.isArray(c)) return renderContentBlocks(c, toolCallNames) + renderMeta(e);
  return `<pre class="text-block">${esc(JSON.stringify(e.message, null, 2))}</pre>`;
}

function renderContentBlocks(blocks, toolCallNames) {
  return blocks.map(b => {
    if (b.type === 'text') return `<div class="content-block text-block">${esc(b.text || '')}</div>`;
    if (b.type === 'tool_use') {
      const inputStr = typeof b.input === 'string' ? b.input : JSON.stringify(b.input, null, 2);
      const preview = (b.input?.command || b.input?.file_path || b.input?.pattern || b.input?.query || b.input?.description || '').toString().slice(0, 80);
      return `<details class="content-block tool-block"><summary><span class="tool-name">${esc(b.name)}</span><span class="tool-input-preview">${esc(preview)}</span></summary><div class="tool-body"><pre>${esc(inputStr)}</pre></div></details>`;
    }
    if (b.type === 'tool_result') {
      const rc = typeof b.content === 'string' ? b.content : (Array.isArray(b.content) ? b.content.map(c => c.text || JSON.stringify(c)).join('\n') : JSON.stringify(b.content, null, 2));
      return `<details class="content-block tool-result-block${b.is_error ? ' result-error' : ''}"><summary><span class="result-label">${b.is_error ? 'ERROR' : 'Result'}: ${esc(toolCallNames[b.tool_use_id] || 'tool')}</span></summary><div class="tool-result-body"><pre>${esc(rc)}</pre></div></details>`;
    }
    return `<pre class="content-block text-block">${esc(JSON.stringify(b, null, 2))}</pre>`;
  }).join('');
}

function renderMeta(e) {
  const p = [];
  if (e.uuid) p.push(`uuid: ${e.uuid.slice(0, 8)}`);
  if (e.requestId) p.push(`req: ${e.requestId.slice(0, 12)}`);
  if (e.message?.model) p.push(`model: ${e.message.model}`);
  if (e._stopReason) p.push(`stop: ${e._stopReason}`);
  if (e.cwd) p.push(`cwd: ${e.cwd}`);
  return p.length ? `<div class="meta-row">${p.map(s => `<span>${esc(s)}</span>`).join('')}</div>` : '';
}

function getTextContent(e, toolCallNames) {
  if (e.type === 'queue-operation') return JSON.stringify(e, null, 2);
  if (e.type === 'summary') return e.summary || '';
  const blocks = e._mergedContent || (Array.isArray(e.message?.content) ? e.message.content : null);
  if (blocks) return blocks.map(b => {
    if (b.type === 'text') return b.text || '';
    if (b.type === 'tool_use') return `[${b.name}] ${typeof b.input === 'string' ? b.input : JSON.stringify(b.input, null, 2)}`;
    if (b.type === 'tool_result') { const rc = typeof b.content === 'string' ? b.content : (Array.isArray(b.content) ? b.content.map(c => c.text || JSON.stringify(c)).join('\n') : JSON.stringify(b.content, null, 2)); return `[Result: ${toolCallNames[b.tool_use_id] || 'tool'}] ${rc}`; }
    return JSON.stringify(b, null, 2);
  }).join('\n\n');
  if (typeof e.message?.content === 'string') return e.message.content;
  return JSON.stringify(e.message || e, null, 2);
}

function copyMessage(btn, e, toolCallNames) {
  const text = getTextContent(e, toolCallNames);
  navigator.clipboard.writeText(text).then(() => {
    btn.innerHTML = CHECK_ICON;
    btn.classList.add('copied');
    setTimeout(() => { btn.innerHTML = COPY_ICON; btn.classList.remove('copied'); }, 1500);
  });
}

function esc(s) { return s ? s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;') : ''; }
</script>
</body>
</html>