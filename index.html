<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Code Log Viewer</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', Consolas, monospace; background: #0d1117; color: #c9d1d9; font-size: 13px; line-height: 1.5; }
#drop-zone { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; }
#drop-zone.has-content { display: none; }
.drop-area { border: 2px dashed #30363d; border-radius: 12px; padding: 3rem; text-align: center; max-width: 500px; width: 100%; transition: border-color 0.2s; }
.drop-area:hover, .drop-area.drag-over { border-color: #58a6ff; }
.drop-area h1 { font-size: 1.3rem; color: #e6edf3; margin-bottom: 0.5rem; font-weight: 600; }
.drop-area p { color: #8b949e; margin-bottom: 1.5rem; font-size: 0.85rem; }
input[type="file"] { display: none; }
.pick-btn { background: #238636; color: #fff; border: none; padding: 0.6rem 1.5rem; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 0.85rem; font-weight: 500; }
.pick-btn:hover { background: #2ea043; }
.btn-row { display: flex; gap: 0.75rem; justify-content: center; margin-bottom: 1.5rem; }
.or-text { color: #484f58; font-size: 0.8rem; margin-bottom: 1rem; }

/* Recent files list */
.recent-list { text-align: left; width: 100%; }
.recent-list h2 { font-size: 0.8rem; color: #8b949e; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; font-weight: 500; }
.recent-item { display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem 0.6rem; border: 1px solid #21262d; border-radius: 6px; margin-bottom: 4px; cursor: pointer; transition: border-color 0.15s, background 0.15s; }
.recent-item:hover { border-color: #58a6ff; background: #161b22; }
.recent-slug { color: #e6edf3; font-size: 0.8rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; }
.recent-project { color: #8b949e; font-size: 0.7rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; flex-shrink: 0; }
.recent-meta { color: #484f58; font-size: 0.7rem; flex-shrink: 0; white-space: nowrap; }
.recent-loading { color: #8b949e; font-size: 0.8rem; padding: 1rem 0; }
.drop-area.has-list { max-width: 700px; }
.refresh-btn { background: none; border: 1px solid #30363d; color: #58a6ff; padding: 0.15rem 0.5rem; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 0.7rem; margin-left: 0.5rem; vertical-align: middle; }
.refresh-btn:hover { background: #161b22; border-color: #58a6ff; }

#viewer { display: none; max-width: 1100px; margin: 0 auto; padding: 1rem; }
#viewer.active { display: block; }

/* Stats bar */
.stats-bar { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem 1.5rem; align-items: center; }
.stat { display: flex; align-items: center; gap: 0.35rem; }
.stat-label { color: #8b949e; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.03em; }
.stat-value { color: #e6edf3; font-weight: 600; font-size: 0.85rem; }
.stat-value.tokens-in { color: #79c0ff; }
.stat-value.tokens-out { color: #7ee787; }
.stat-value.tokens-cache { color: #d2a8ff; }

/* Toolbar */
.toolbar { display: flex; gap: 0.5rem; margin-bottom: 1rem; align-items: center; }
.toolbar button { background: #21262d; border: 1px solid #30363d; color: #c9d1d9; padding: 0.35rem 0.75rem; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 0.75rem; }
.toolbar button:hover { background: #30363d; border-color: #8b949e; }
.toolbar button.active { background: #1f6feb; border-color: #1f6feb; color: #fff; }
.toolbar .spacer { flex: 1; }
.toolbar .file-name { color: #8b949e; font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 400px; }
.reload-btn { background: none; border: none; color: #58a6ff; cursor: pointer; font-family: inherit; font-size: 0.75rem; text-decoration: underline; }

/* Message list */
.message { border: 1px solid #21262d; border-radius: 8px; margin-bottom: 6px; overflow: hidden; transition: border-color 0.15s; }
.message:hover { border-color: #30363d; }
.message.type-user { border-left: 3px solid #58a6ff; }
.message.type-assistant { border-left: 3px solid #7ee787; }
.message.type-system { border-left: 3px solid #d29922; }
.message.type-queue-operation { border-left: 3px solid #8b949e; }
.message.type-summary { border-left: 3px solid #d2a8ff; }

.msg-header { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; user-select: none; background: #161b22; }
.msg-header:hover { background: #1c2128; }
.msg-chevron { color: #484f58; font-size: 0.7rem; transition: transform 0.15s; width: 1em; flex-shrink: 0; }
.message.open .msg-chevron { transform: rotate(90deg); }

.badge { padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; flex-shrink: 0; }
.badge-user { background: #0d419d; color: #a5d6ff; }
.badge-assistant { background: #0f5323; color: #7ee787; }
.badge-system { background: #4d2d00; color: #e3b341; }
.badge-queue-operation { background: #21262d; color: #8b949e; }
.badge-summary { background: #2d1f4e; color: #d2a8ff; }

.msg-preview { color: #8b949e; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.8rem; min-width: 0; }
.msg-time { color: #484f58; font-size: 0.7rem; flex-shrink: 0; }
.msg-tokens { font-size: 0.7rem; flex-shrink: 0; display: flex; gap: 0.4rem; }
.msg-tokens span { padding: 0.1rem 0.4rem; border-radius: 4px; }
.tok-in { background: #0d2744; color: #79c0ff; }
.tok-out { background: #0a3622; color: #7ee787; }
.tok-cache { background: #231a3a; color: #d2a8ff; }

.msg-body { display: none; padding: 0.75rem; background: #0d1117; border-top: 1px solid #21262d; }
.message.open .msg-body { display: block; }

/* Content blocks inside message body */
.content-block { margin-bottom: 0.75rem; }
.content-block:last-child { margin-bottom: 0; }
.text-block { white-space: pre-wrap; word-break: break-word; color: #c9d1d9; }
.text-block code { background: #161b22; padding: 0.15rem 0.35rem; border-radius: 4px; font-size: 0.9em; }

.tool-block { border: 1px solid #30363d; border-radius: 6px; overflow: hidden; }
.tool-block summary { padding: 0.4rem 0.6rem; background: #161b22; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.4rem; list-style: none; }
.tool-block summary::-webkit-details-marker { display: none; }
.tool-block summary::before { content: '\25b6'; font-size: 0.6rem; color: #484f58; transition: transform 0.15s; }
.tool-block[open] summary::before { transform: rotate(90deg); }
.tool-name { color: #d2a8ff; font-weight: 600; }
.tool-input-preview { color: #8b949e; margin-left: 0.3rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.tool-body { padding: 0.5rem 0.6rem; background: #0d1117; max-height: 400px; overflow: auto; }
.tool-body pre { white-space: pre-wrap; word-break: break-word; font-size: 0.8rem; color: #8b949e; }

.tool-result-block { border: 1px solid #30363d; border-radius: 6px; overflow: hidden; }
.tool-result-block summary { padding: 0.4rem 0.6rem; background: #1a1e24; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.4rem; list-style: none; }
.tool-result-block summary::-webkit-details-marker { display: none; }
.tool-result-block summary::before { content: '\25b6'; font-size: 0.6rem; color: #484f58; transition: transform 0.15s; }
.tool-result-block[open] summary::before { transform: rotate(90deg); }
.result-label { color: #79c0ff; font-weight: 600; }
.result-error .result-label { color: #f85149; }
.tool-result-body { padding: 0.5rem 0.6rem; background: #0d1117; max-height: 400px; overflow: auto; }
.tool-result-body pre { white-space: pre-wrap; word-break: break-word; font-size: 0.8rem; color: #8b949e; }

/* Metadata row */
.meta-row { display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.7rem; color: #484f58; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #21262d; }
.meta-row span { display: flex; align-items: center; gap: 0.25rem; }

/* Filter hidden */
.message.filter-hidden { display: none; }

/* Scrollbar */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: #0d1117; }
::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #484f58; }
</style>
</head>
<body>

<div id="drop-zone">
  <div class="drop-area" id="drop-area">
    <h1>Claude Code Log Viewer</h1>
    <p>Drop a .jsonl file or the ~/.claude/projects/ folder</p>
    <div class="btn-row">
      <button class="pick-btn" onclick="document.getElementById('file-input').click()">Choose .jsonl file</button>
      <button class="pick-btn" id="pick-dir-btn" style="background:#1f6feb">Choose projects folder</button>
    </div>
    <input type="file" id="file-input" accept=".jsonl">
    <div id="recent-container"></div>
  </div>
</div>

<div id="viewer">
  <div class="stats-bar" id="stats-bar"></div>
  <div class="toolbar" id="toolbar"></div>
  <div id="messages"></div>
</div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

// File handling
const fileInput = $('#file-input');
const dropArea = $('#drop-area');
const dropZone = $('#drop-zone');
const viewer = $('#viewer');

fileInput.addEventListener('change', e => { if (e.target.files[0]) loadFile(e.target.files[0]); });

dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('drag-over'); });
dropArea.addEventListener('dragleave', () => dropArea.classList.remove('drag-over'));
dropArea.addEventListener('drop', e => {
  e.preventDefault();
  dropArea.classList.remove('drag-over');
  if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
});

// "Choose projects folder" button — File System Access API
$('#pick-dir-btn').addEventListener('click', pickDirectory);

async function pickDirectory() {
  try {
    const dirHandle = await window.showDirectoryPicker({ startIn: lastDirHandle || 'documents' });
    await storeDirHandle(dirHandle);
    scanDirHandle(dirHandle);
  } catch {}
}

let currentFileName = '';
let lastDirHandle = null;

// --- IndexedDB persistence for directory handle ---

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('log-viewer', 1);
    req.onupgradeneeded = () => req.result.createObjectStore('kv');
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function storeDirHandle(handle) {
  try {
    const db = await openDB();
    const tx = db.transaction('kv', 'readwrite');
    tx.objectStore('kv').put(handle, 'projectsDir');
    await new Promise(r => { tx.oncomplete = r; });
  } catch {}
}

async function loadStoredDirHandle() {
  try {
    const db = await openDB();
    const tx = db.transaction('kv', 'readonly');
    const req = tx.objectStore('kv').get('projectsDir');
    return new Promise(resolve => {
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => resolve(null);
    });
  } catch { return null; }
}

// On page load, try to restore saved directory handle
(async function autoLoad() {
  const handle = await loadStoredDirHandle();
  if (!handle) return;
  const perm = await handle.queryPermission({ mode: 'read' });
  if (perm === 'granted') {
    scanDirHandle(handle);
  } else {
    // Need user gesture to re-grant permission
    lastDirHandle = handle;
    $('#pick-dir-btn').textContent = 'Open saved projects folder';
    const origHandler = $('#pick-dir-btn').onclick;
    $('#pick-dir-btn').onclick = async () => {
      const p = await handle.requestPermission({ mode: 'read' });
      if (p === 'granted') scanDirHandle(handle);
      else pickDirectory(); // permission denied, let user pick fresh
    };
  }
})();

// --- Directory scanning ---

async function rescanDirectory() {
  if (lastDirHandle) scanDirHandle(lastDirHandle);
}

async function scanDirHandle(dirHandle) {
  lastDirHandle = dirHandle;
  const container = $('#recent-container');
  container.innerHTML = '<div class="recent-loading">Scanning for .jsonl files...</div>';
  dropArea.classList.add('has-list');
  const files = [];
  await walkHandle(dirHandle, '', files);
  showRecentFiles(files);
}

async function walkHandle(dirHandle, path, files) {
  for await (const entry of dirHandle.values()) {
    if (entry.kind === 'file' && entry.name.endsWith('.jsonl')) {
      const file = await entry.getFile();
      file._dirPath = path; // track parent directory name for project extraction
      files.push(file);
    } else if (entry.kind === 'directory') {
      await walkHandle(entry, entry.name, files);
    }
  }
}

// Parse quick stats from a JSONL file (reads first ~50 lines + last chunk)
function parseQuickStats(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      const text = e.target.result;
      const lines = text.split('\n').filter(l => l.trim());
      let firstMsg = '', model = '', firstTs = null, lastTs = null;
      let turns = 0, msgCount = lines.length;
      const reqIds = new Set();
      for (const line of lines) {
        try {
          const obj = JSON.parse(line);
          const ts = obj.timestamp ? new Date(obj.timestamp) : null;
          if (ts) {
            if (!firstTs || ts < firstTs) firstTs = ts;
            if (!lastTs || ts > lastTs) lastTs = ts;
          }
          if (!model && obj.message?.model) model = obj.message.model;
          if (obj.type === 'assistant' && obj.requestId) reqIds.add(obj.requestId);
          if (!firstMsg && obj.type === 'user') {
            const c = obj.message?.content;
            if (typeof c === 'string') firstMsg = c.split('\n')[0].slice(0, 150);
            else if (Array.isArray(c)) {
              for (const b of c) {
                if (b.type === 'text' && b.text?.trim()) { firstMsg = b.text.trim().split('\n')[0].slice(0, 150); break; }
              }
            }
          }
        } catch {}
      }
      turns = reqIds.size;
      resolve({ firstMsg, model, firstTs, lastTs, turns, msgCount });
    };
    reader.readAsText(file);
  });
}

async function showRecentFiles(files) {
  // Sort by lastModified descending, take top 10
  files.sort((a, b) => b.lastModified - a.lastModified);
  const top = files.slice(0, 10);

  const container = $('#recent-container');
  if (!top.length) {
    container.innerHTML = '<div class="recent-loading">No .jsonl files found.</div>';
    return;
  }
  container.innerHTML = '<div class="recent-loading">Parsing stats...</div>';

  const infos = [];
  for (const f of top) {
    const stats = await parseQuickStats(f);
    const project = extractProject(f);
    infos.push({ file: f, stats, project });
  }

  container.innerHTML = `<div class="recent-list"><h2>Recent sessions (${files.length} total) <button class="refresh-btn" id="refresh-btn">Refresh</button></h2></div>`;
  const list = container.querySelector('.recent-list');
  $('#refresh-btn').addEventListener('click', () => rescanDirectory());

  for (const { file: f, stats, project } of infos) {
    const el = document.createElement('div');
    el.className = 'recent-item';

    const label = stats.firstMsg || f.name.replace('.jsonl', '').slice(0, 20);
    const sizeStr = f.size >= 1048576 ? (f.size / 1048576).toFixed(1) + ' MB' : f.size >= 1024 ? (f.size / 1024).toFixed(0) + ' KB' : f.size + ' B';
    const dateStr = stats.lastTs ? relativeTime(stats.lastTs) : relativeTime(new Date(f.lastModified));
    const turnStr = stats.turns ? stats.turns + ' turns' : '';
    const modelStr = stats.model ? stats.model.replace('claude-', '').split('-202')[0] : '';

    el.innerHTML = `
      <span class="recent-slug" title="${esc(label)}">${esc(label)}</span>
      <span class="recent-project" title="${esc(project)}">${esc(project)}</span>
      <span class="recent-meta">${[modelStr, turnStr, sizeStr, dateStr].filter(Boolean).join(' · ')}</span>
    `;
    el.addEventListener('click', () => loadFile(f));
    list.appendChild(el);
  }
}

function extractProject(file) {
  // _dirPath is set by walkHandle — it's the parent directory name
  // e.g. "-home-v-vishpro" → "home/v/vishpro"
  const dir = file._dirPath || '';
  if (dir) return dir.replace(/^-/, '').replaceAll('-', '/');
  return '';
}

function relativeTime(date) {
  const now = Date.now();
  const diff = now - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  if (days < 7) return days + 'd ago';
  return date.toLocaleDateString();
}

function loadFile(file) {
  currentFileName = file.name;
  // Switch to viewer immediately so the user sees something
  dropZone.classList.add('has-content');
  viewer.classList.add('active');
  $('#stats-bar').innerHTML = '';
  $('#toolbar').innerHTML = `<span class="file-name">${esc(file.name)}</span><span class="spacer"></span>`;
  $('#messages').innerHTML = '<div class="recent-loading">Loading ' + esc(file.name) + '...</div>';
  // Read file async
  const reader = new FileReader();
  reader.onload = e => {
    const lines = e.target.result.split('\n').filter(l => l.trim());
    const entries = [];
    for (const line of lines) {
      try { entries.push(JSON.parse(line)); } catch {}
    }
    render(entries);
  };
  reader.readAsText(file);
}

function render(entries) {
  dropZone.classList.add('has-content');
  viewer.classList.add('active');

  // Compute stats
  const stats = { inputTokens: 0, outputTokens: 0, cacheRead: 0, cacheWrite: 0, turns: 0, messages: entries.length, model: '', firstTs: null, lastTs: null };
  const assistantMsgs = [];
  const typeSet = new Set();

  for (const e of entries) {
    typeSet.add(e.type);
    const ts = e.timestamp ? new Date(e.timestamp) : null;
    if (ts) {
      if (!stats.firstTs || ts < stats.firstTs) stats.firstTs = ts;
      if (!stats.lastTs || ts > stats.lastTs) stats.lastTs = ts;
    }

    if (e.type === 'assistant') {
      const u = e.message?.usage;
      if (u) {
        stats.inputTokens += u.input_tokens || 0;
        stats.outputTokens += u.output_tokens || 0;
        stats.cacheRead += u.cache_read_input_tokens || 0;
        stats.cacheWrite += u.cache_creation_input_tokens || 0;
      }
      if (!stats.model && e.message?.model) stats.model = e.message.model;

      // Count turns: an assistant entry whose content has text or tool_use with stop_reason
      if (e.message?.stop_reason === 'end_turn' || e.message?.stop_reason === 'stop_sequence') {
        stats.turns++;
      }
    }
  }

  // If no stop_reason-based turns counted, count by unique requestId
  if (stats.turns === 0) {
    const reqIds = new Set();
    for (const e of entries) {
      if (e.type === 'assistant' && e.requestId) reqIds.add(e.requestId);
    }
    stats.turns = reqIds.size;
  }

  const duration = stats.firstTs && stats.lastTs ? Math.round((stats.lastTs - stats.firstTs) / 1000) : 0;
  const durationStr = duration > 0 ? (duration < 60 ? `${duration}s` : `${Math.floor(duration/60)}m ${duration%60}s`) : '-';

  // Render stats bar
  const fmt = n => n >= 1000000 ? (n/1000000).toFixed(1) + 'M' : n >= 1000 ? (n/1000).toFixed(1) + 'k' : String(n);
  $('#stats-bar').innerHTML = [
    stat('Model', stats.model || '-', ''),
    stat('Duration', durationStr, ''),
    stat('Turns', stats.turns, ''),
    stat('Messages', stats.messages, ''),
    stat('Input', fmt(stats.inputTokens), 'tokens-in'),
    stat('Output', fmt(stats.outputTokens), 'tokens-out'),
    stat('Cache Read', fmt(stats.cacheRead), 'tokens-cache'),
    stat('Cache Write', fmt(stats.cacheWrite), 'tokens-cache'),
  ].join('');

  // Render toolbar
  const visibleTypes = ['user', 'assistant', 'system', 'queue-operation', 'summary'];
  const filterTypes = visibleTypes.filter(t => typeSet.has(t));
  const skipTypes = new Set(['file-history-snapshot', 'progress']);

  $('#toolbar').innerHTML = `
    <span class="file-name" title="${esc(currentFileName)}">${esc(currentFileName)}</span>
    <span class="spacer"></span>
    ${filterTypes.map(t => `<button class="filter-btn active" data-type="${t}">${t}</button>`).join('')}
    <button id="expand-all-btn">Expand All</button>
    <button id="collapse-all-btn">Collapse All</button>
    <button class="reload-btn" id="back-btn">Back</button>
  `;

  // Filter buttons
  $$('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      btn.classList.toggle('active');
      applyFilters();
    });
  });

  $('#back-btn').addEventListener('click', () => {
    dropZone.classList.remove('has-content');
    viewer.classList.remove('active');
    $('#messages').innerHTML = '';
    if (lastDirEntry || lastDirHandle) rescanDirectory();
  });

  $('#expand-all-btn').addEventListener('click', () => {
    $$('.message:not(.filter-hidden)').forEach(m => m.classList.add('open'));
  });
  $('#collapse-all-btn').addEventListener('click', () => {
    $$('.message').forEach(m => m.classList.remove('open'));
  });

  // Render messages
  const container = $('#messages');
  container.innerHTML = '';

  // Group consecutive assistant entries with the same requestId (streaming chunks)
  const grouped = [];
  let i = 0;
  while (i < entries.length) {
    const e = entries[i];
    if (skipTypes.has(e.type)) { i++; continue; }

    if (e.type === 'assistant' && e.requestId) {
      // Merge all assistant entries with same requestId
      const reqId = e.requestId;
      const group = { ...e, _mergedContent: [], _usage: null };
      while (i < entries.length && entries[i].type === 'assistant' && entries[i].requestId === reqId) {
        const a = entries[i];
        if (a.message?.content) {
          for (const block of a.message.content) {
            group._mergedContent.push(block);
          }
        }
        if (a.message?.usage) group._usage = a.message.usage;
        if (a.message?.stop_reason) group._stopReason = a.message.stop_reason;
        if (!group.timestamp && a.timestamp) group.timestamp = a.timestamp;
        i++;
      }
      grouped.push(group);
    } else {
      grouped.push(e);
      i++;
    }
  }

  // Build tool call ID map for linking results
  const toolCallNames = {};
  for (const e of grouped) {
    if (e._mergedContent) {
      for (const b of e._mergedContent) {
        if (b.type === 'tool_use') toolCallNames[b.id] = b.name;
      }
    }
  }

  for (const e of grouped) {
    const msgEl = document.createElement('div');
    msgEl.className = `message type-${e.type}`;
    msgEl.dataset.type = e.type;

    const timeStr = e.timestamp ? new Date(e.timestamp).toLocaleTimeString() : '';
    const preview = getPreview(e);
    const tokens = getTokenHTML(e);

    msgEl.innerHTML = `
      <div class="msg-header">
        <span class="msg-chevron">&#9654;</span>
        <span class="badge badge-${e.type}">${badgeLabel(e)}</span>
        <span class="msg-preview">${esc(preview)}</span>
        ${tokens}
        <span class="msg-time">${timeStr}</span>
      </div>
      <div class="msg-body">${renderBody(e, toolCallNames)}</div>
    `;

    msgEl.querySelector('.msg-header').addEventListener('click', () => {
      msgEl.classList.toggle('open');
    });

    container.appendChild(msgEl);
  }

  applyFilters();
}

function applyFilters() {
  const active = new Set();
  $$('.filter-btn.active').forEach(b => active.add(b.dataset.type));
  $$('.message').forEach(m => {
    m.classList.toggle('filter-hidden', !active.has(m.dataset.type));
  });
}

function stat(label, value, cls) {
  return `<div class="stat"><span class="stat-label">${label}</span><span class="stat-value ${cls}">${value}</span></div>`;
}

function badgeLabel(e) {
  if (e.type === 'queue-operation') return 'queue';
  if (e.type === 'system') return e.subtype || 'system';
  return e.type;
}

function getPreview(e) {
  if (e.type === 'queue-operation') return `${e.operation || ''} — session ${(e.sessionId || '').slice(0, 8)}`;
  if (e.type === 'summary') return e.summary || '';

  if (e._mergedContent) {
    for (const b of e._mergedContent) {
      if (b.type === 'text' && b.text?.trim()) return b.text.trim().slice(0, 120);
      if (b.type === 'tool_use') return `tool: ${b.name}`;
    }
    return '(empty)';
  }

  const msg = e.message;
  if (!msg) {
    if (e.type === 'system') return e.subtype ? `${e.subtype}${e.durationMs ? ' — ' + (e.durationMs / 1000).toFixed(1) + 's' : ''}` : '(system)';
    return '(no content)';
  }

  const content = msg.content;
  if (typeof content === 'string') return content.slice(0, 120);
  if (Array.isArray(content)) {
    for (const b of content) {
      if (b.type === 'text' && b.text?.trim()) return b.text.trim().slice(0, 120);
      if (b.type === 'tool_result') {
        const rc = typeof b.content === 'string' ? b.content : (b.content?.[0]?.text || '');
        return `result: ${rc.slice(0, 100)}`;
      }
    }
  }
  return '(no content)';
}

function getTokenHTML(e) {
  const u = e._usage || e.message?.usage;
  if (!u) return '';
  const parts = [];
  const inp = (u.input_tokens || 0) + (u.cache_read_input_tokens || 0) + (u.cache_creation_input_tokens || 0);
  if (inp) parts.push(`<span class="tok-in">in:${fmtTok(inp)}</span>`);
  if (u.output_tokens) parts.push(`<span class="tok-out">out:${fmtTok(u.output_tokens)}</span>`);
  const cached = (u.cache_read_input_tokens || 0);
  if (cached) parts.push(`<span class="tok-cache">cached:${fmtTok(cached)}</span>`);
  return parts.length ? `<span class="msg-tokens">${parts.join('')}</span>` : '';
}

function fmtTok(n) { return n >= 1000 ? (n/1000).toFixed(1) + 'k' : String(n); }

function renderBody(e, toolCallNames) {
  if (e.type === 'queue-operation') {
    return `<pre class="text-block">${esc(JSON.stringify(e, null, 2))}</pre>`;
  }
  if (e.type === 'summary') {
    return `<div class="text-block">${esc(e.summary || '')}</div>`;
  }
  if (e.type === 'system') {
    const parts = [];
    if (e.subtype) parts.push(`Subtype: ${e.subtype}`);
    if (e.durationMs) parts.push(`Duration: ${(e.durationMs / 1000).toFixed(1)}s`);
    parts.push(JSON.stringify(e, null, 2));
    return `<pre class="text-block">${esc(parts.join('\n'))}</pre>`;
  }

  // Merged assistant
  if (e._mergedContent) {
    return renderContentBlocks(e._mergedContent, toolCallNames) + renderMeta(e);
  }

  // User or other with message
  const msg = e.message;
  if (!msg) return `<pre class="text-block">${esc(JSON.stringify(e, null, 2))}</pre>`;

  const content = msg.content;
  if (typeof content === 'string') {
    return `<div class="text-block">${esc(content)}</div>` + renderMeta(e);
  }
  if (Array.isArray(content)) {
    return renderContentBlocks(content, toolCallNames) + renderMeta(e);
  }
  return `<pre class="text-block">${esc(JSON.stringify(msg, null, 2))}</pre>`;
}

function renderContentBlocks(blocks, toolCallNames) {
  return blocks.map(b => {
    if (b.type === 'text') {
      return `<div class="content-block text-block">${esc(b.text || '')}</div>`;
    }
    if (b.type === 'tool_use') {
      const inputStr = typeof b.input === 'string' ? b.input : JSON.stringify(b.input, null, 2);
      const inputPreview = (b.input?.command || b.input?.file_path || b.input?.pattern || b.input?.query || b.input?.description || '').toString().slice(0, 80);
      return `<details class="content-block tool-block">
        <summary><span class="tool-name">${esc(b.name)}</span><span class="tool-input-preview">${esc(inputPreview)}</span></summary>
        <div class="tool-body"><pre>${esc(inputStr)}</pre></div>
      </details>`;
    }
    if (b.type === 'tool_result') {
      const rc = typeof b.content === 'string' ? b.content : (Array.isArray(b.content) ? b.content.map(c => c.text || JSON.stringify(c)).join('\n') : JSON.stringify(b.content, null, 2));
      const toolName = toolCallNames[b.tool_use_id] || 'tool';
      const isErr = b.is_error;
      return `<details class="content-block tool-result-block${isErr ? ' result-error' : ''}">
        <summary><span class="result-label">${isErr ? 'ERROR' : 'Result'}: ${esc(toolName)}</span></summary>
        <div class="tool-result-body"><pre>${esc(rc)}</pre></div>
      </details>`;
    }
    return `<pre class="content-block text-block">${esc(JSON.stringify(b, null, 2))}</pre>`;
  }).join('');
}

function renderMeta(e) {
  const parts = [];
  if (e.uuid) parts.push(`uuid: ${e.uuid.slice(0, 8)}`);
  if (e.requestId) parts.push(`req: ${e.requestId.slice(0, 12)}`);
  if (e.message?.model) parts.push(`model: ${e.message.model}`);
  if (e._stopReason) parts.push(`stop: ${e._stopReason}`);
  if (e.cwd) parts.push(`cwd: ${e.cwd}`);
  if (!parts.length) return '';
  return `<div class="meta-row">${parts.map(p => `<span>${esc(p)}</span>`).join('')}</div>`;
}

function esc(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}
</script>
</body>
</html>
